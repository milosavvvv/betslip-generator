<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bet Slip</title>
    <link rel="stylesheet" href="style.css" />
</head>
  <body>
    <main class="layout">
      <section class="panel">
        <h2>Edit Slip</h2>
        <div class="row">
          <div>
            <label for="fSlipDate">Slip Date</label>
            <input id="fSlipDate" data-bind="slipDateISO" type="date" value="2026-02-06" />
          </div>
          <div>
            <label for="fSlipTime">Slip Time</label>
            <input id="fSlipTime" data-bind="slipTimeISO" type="time" value="11:45" />
          </div>
        </div>

        <label>Slip ID</label>
        <div class="row">
          <div>
            <button id="genId" type="button">Generate ID</button>
          </div>
          <div>
            <input id="customId" type="text" placeholder="Custom ID" />
          </div>
        </div>


        <div class="row">
          <div>
            <label for="fOdds">Slip Odds</label>
            <input id="fOdds" data-bind="slipOdds" value="1.5" />
          </div>
          <div>
            <label for="fStake">Bet Amount</label>
            <input id="fStake" data-bind="betAmount" value="100.00" />
          </div>
        </div>

        <label for="fMarket">Market</label>
        <input id="fMarket" data-bind="market" value="Both teams to score, Yes" />

        <div class="row league-row">
          <div>
            <label for="fLeague">League</label>
            <select id="fLeague" data-bind="league"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="fKickTime">Kickoff Time</label>
            <input id="fKickTime" data-bind="kickoffTimeISO" type="time" value="19:30" />
          </div>
          <div>
            <label for="fKickDate">Kickoff Date</label>
            <input id="fKickDate" data-bind="kickoffDateISO" type="date" value="2026-02-06" />
          </div>
        </div>


        <div class="row">
          <div>
            <label for="fTeam1">Team 1</label>
            <input id="fTeam1" data-bind="team1" value="Al-Nassr" />
          </div>
          <div>
            <label for="fTeam2">Team 2</label>
            <input id="fTeam2" data-bind="team2" value="Al Ittihad Jeddah" />
          </div>
        </div>

        <div class="score-row">
          <div>
            <label for="fT1H1">Team 1 - 1st</label>
            <input class="score-input" id="fT1H1" data-bind="t1h1" value="0" />
          </div>
          <div>
            <label for="fT1H2">Team 1 - 2nd</label>
            <input class="score-input" id="fT1H2" data-bind="t1h2" value="0" />
          </div>
        </div>
        <div class="score-row">
          <div>
            <label for="fT2H1">Team 2 - 1st</label>
            <input class="score-input" id="fT2H1" data-bind="t2h1" value="3" />
          </div>
          <div>
            <label for="fT2H2">Team 2 - 2nd</label>
            <input class="score-input" id="fT2H2" data-bind="t2h2" value="2" />
          </div>
        </div>
        <button class="btn-download" id="btnDownload" type="button">Download</button>

      </section>

      <section class="wrap export-card" id="openedExport">
        <section class="slip">
          <div class="slip-top">
            <span class="date">
              <span data-out="slipDate">6 February 2026</span>
              <span> at </span>
              <span data-out="slipTime">11:45 AM</span>
            </span>
            <span class="id">ID <span data-out="slipId">200206627</span></span>
          </div>
          <div class="slip-body">
            <div class="slip-row">
              <span class="type" data-out="slipType">Single</span>
              <div class="slip-row">
                <span class="badge" data-out="slipOdds">1.5</span>
                <span class="status">
                  <span class="clock-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="img" focusable="false">
                      <path d="M12 7v5l3 2" />
                    </svg>
                  </span>
                  Opened
                </span>
              </div>
            </div>
            <div class="amounts">
              <div>
                <div class="label">Bet amount</div>
                <div class="value" data-out="betAmount">&euro; 0</div>
              </div>
              <div style="text-align: right">
                <div class="label">Possible win</div>
                <div class="value" data-out="possibleWin">&euro; 0</div>
              </div>
            </div>
          </div>
        </section>

        <div class="section-title" data-out="eventCount">1 event</div>

        <section class="event-card">
          <div class="event-header">
            <h3 data-out="market">Both teams to score, Yes</h3>
            <span class="odds-pill" data-out="eventOdds">1.5</span>
          </div>
          <div class="meta">
            <span>
              <span class="ball" aria-hidden="true">
                <img src="soccer-ball-thin.svg" alt="" />
              </span>
              <span data-out="league">Saudi Arabia Professional League</span>
            </span>
            <span>
              <span class="clock" aria-hidden="true">
                <svg viewBox="0 0 24 24" role="img" focusable="false">
                  <circle cx="12" cy="12" r="10.5" fill="#5a5f6b" />
                  <path d="M12 7.2v5.1l3.6 2.1" fill="none" stroke="#ffffff" stroke-linecap="round" stroke-width="2" />
                </svg>
              </span>
              <span data-out="kickoffTime">07:30 PM</span>
              <span> · </span>
              <span data-out="kickoffDate">06/02/2026</span>
            </span>
          </div>
          <div class="status-line" data-out="eventStatus">Not started yet</div>
          <div class="teams">
            <div data-out="team1">Al-Nassr</div>
            <div data-out="team2">Al Ittihad Jeddah</div>
          </div>
        </section>

        <div class="cashout" data-out="cashout">Cash out for &euro; 1,534.74</div>
      </section>

      <section class="wrap export-card" id="wonExport">
        <section class="slip won">
          <div class="slip-top">
            <span class="date">
              <span data-out="slipDate">6 February 2026</span>
              <span> at </span>
              <span data-out="slipTime">11:45 AM</span>
            </span>
            <span class="id">ID <span data-out="slipId">200206627</span></span>
          </div>
          <div class="slip-body">
            <div class="slip-row">
              <span class="type" data-out="slipType">Single</span>
              <div class="slip-row">
                <span class="badge" data-out="slipOdds">1.5</span>
                <span class="status">
                  <span class="check-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="img" focusable="false">
                      <path d="M9.4 16.2 5.7 12.5l1.4-1.4 2.3 2.3 7-7 1.4 1.4-8.4 8.4Z" />
                    </svg>
                  </span>
                  Won
                </span>
              </div>
            </div>
            <div class="amounts">
              <div>
                <div class="label">Bet amount</div>
                <div class="value" data-out="betAmount">&euro; 0</div>
              </div>
              <div style="text-align: right">
                <div class="label">Profit amount</div>
                <div class="value" data-out="possibleWin">&euro; 0</div>
              </div>
            </div>
          </div>
        </section>

        <div class="section-title">1 event</div>

        <section class="event-card">
          <div class="event-header">
            <h3 data-out="market">Both teams to score, Yes</h3>
            <span class="odds-pill green" data-out="eventOdds">1.5</span>
          </div>
          <div class="meta">
            <span>
              <span class="ball" aria-hidden="true">
                <img src="soccer-ball-thin.svg" alt="" />
              </span>
              <span data-out="league">Saudi Arabia Professional League</span>
            </span>
            <span>
              <span class="clock" aria-hidden="true">
                <svg viewBox="0 0 24 24" role="img" focusable="false">
                  <circle cx="12" cy="12" r="10.5" fill="#5a5f6b" />
                  <path d="M12 7.2v5.1l3.6 2.1" fill="none" stroke="#ffffff" stroke-linecap="round" stroke-width="2" />
                </svg>
              </span>
              <span data-out="kickoffTime">07:30 PM</span>
              <span> · </span>
              <span data-out="kickoffDate">06/02/2026</span>
            </span>
          </div>
          <div class="status-row">
            <div class="status-line">Finished</div>
            <div class="score-table" aria-hidden="true">
              <div class="head">
                <span>1</span>
                <span>2</span>
                <span>S</span>
              </div>
            </div>
          </div>
          <div class="scoreboard">
            <div class="teams">
              <div data-out="team1">Al-Nassr</div>
              <div data-out="team2">Al Ittihad Jeddah</div>
            </div>
            <div class="score-table" aria-hidden="true">
              <div class="row">
                <span data-out="t1h1">0</span>
                <span data-out="t1h2">0</span>
                <span class="total" data-out="t1s">0</span>
              </div>
              <div class="row">
                <span data-out="t2h1">3</span>
                <span data-out="t2h2">2</span>
                <span class="total" data-out="t2s">5</span>
              </div>
            </div>
          </div>
        </section>
      </section>
    </main>

    <script src="leagues.js"></script>
    <script>
      const inputs = Array.from(document.querySelectorAll("[data-bind]"));
      const outputs = Array.from(document.querySelectorAll("[data-out]"));
      const leagueSelect = document.getElementById("fLeague");
      const groups = outputs.reduce((acc, el) => {
        const key = el.dataset.out;
        if (!acc.has(key)) acc.set(key, []);
        acc.get(key).push(el);
        return acc;
      }, new Map());

      const setText = (key, value) => {
        const nodes = groups.get(key);
        if (!nodes) return;
        nodes.forEach((node) => {
          node.textContent = value;
        });
      };

      const formatNumber = (value) =>
        value.toLocaleString("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });

      const formatCurrency = (value) => `€ ${formatNumber(value)}`;
      const formatDateLong = (iso) => {
        if (!iso) return "";
        const date = new Date(`${iso}T00:00:00`);
        return date.toLocaleDateString("en-US", {
          day: "numeric",
          month: "long",
          year: "numeric",
        });
      };

      const formatDateShort = (iso) => {
        if (!iso) return "";
        const [y, m, d] = iso.split("-");
        return `${d}/${m}/${y}`;
      };

      const formatTime12 = (time) => {
        if (!time) return "";
        const [h, min] = time.split(":").map((v) => parseInt(v, 10));
        const hour12 = ((h + 11) % 12) + 1;
        const ampm = h >= 12 ? "PM" : "AM";
        return `${hour12}:${String(min).padStart(2, "0")} ${ampm}`;
      };

      const sync = (input) => {
        const key = input.dataset.bind;

        if (key === "slipDateISO") {
          setText("slipDate", formatDateLong(input.value));
          return;
        }

        if (key === "slipTimeISO") {
          setText("slipTime", formatTime12(input.value));
          return;
        }

        if (key === "kickoffDateISO") {
          setText("kickoffDate", formatDateShort(input.value));
          return;
        }

        if (key === "kickoffTimeISO") {
          setText("kickoffTime", formatTime12(input.value));
          return;
        }

        if (key === "betAmount") {
          const bet = parseNumber(input.value);
          if (Number.isFinite(bet)) {
            const formatted = formatNumber(bet);
            if (document.activeElement !== input) input.value = formatted;
            setText("betAmount", formatCurrency(bet));
            setText("cashout", `Cash out for ${formatCurrency(bet)}`);
          }
          return;
        }

        if (key === "slipOdds") {
          setText("slipOdds", input.value);
          setText("eventOdds", input.value);
          return;
        }

        if (key === "possibleWin") {
          const win = parseNumber(input.value);
          if (Number.isFinite(win)) {
            setText("possibleWin", formatCurrency(win));
          }
          return;
        }

        setText(key, input.value);
      };

      const betInput = inputs.find((input) => input.dataset.bind === "betAmount");
      const oddsInput = inputs.find((input) => input.dataset.bind === "slipOdds");
      const winInput = inputs.find((input) => input.dataset.bind === "possibleWin");
      const downloadBtn = document.getElementById("btnDownload");
      const customIdInput = document.getElementById("customId");
      const genIdBtn = document.getElementById("genId");

      const parseNumber = (value) => {
        const cleaned = value
          .replace(/[^\d.,-]/g, "")
          .replace(/\s/g, "")
          .replace(/,(?=\d{3}(\D|$))/g, "");
        return parseFloat(cleaned.replace(",", "."));
      };

      const updatePossibleWin = () => {
        if (!betInput || !oddsInput) return;
        const bet = parseNumber(betInput.value);
        const odds = parseNumber(oddsInput.value);
        if (!Number.isFinite(bet) || !Number.isFinite(odds)) return;
        const result = bet * odds;
        const formatted = formatNumber(result);
        if (winInput) winInput.value = formatted;
        setText("possibleWin", formatCurrency(result));
      };

      const updateScores = () => {
        const t1h1 = parseNumber(inputs.find((i) => i.dataset.bind === "t1h1")?.value || "0");
        const t1h2 = parseNumber(inputs.find((i) => i.dataset.bind === "t1h2")?.value || "0");
        const t2h1 = parseNumber(inputs.find((i) => i.dataset.bind === "t2h1")?.value || "0");
        const t2h2 = parseNumber(inputs.find((i) => i.dataset.bind === "t2h2")?.value || "0");

        if (Number.isFinite(t1h1) && Number.isFinite(t1h2)) {
          setText("t1s", String(t1h1 + t1h2));
        }
        if (Number.isFinite(t2h1) && Number.isFinite(t2h2)) {
          setText("t2s", String(t2h1 + t2h2));
        }
      };

      if (leagueSelect && Array.isArray(window.LEAGUES)) {
        const currentLeague = document.querySelector('[data-out="league"]')?.textContent?.trim();
        const list = window.LEAGUES.slice();
        if (currentLeague && !list.includes(currentLeague)) {
          list.unshift(currentLeague);
        }
        list.forEach((league) => {
          const opt = document.createElement("option");
          opt.value = league;
          opt.textContent = league;
          leagueSelect.appendChild(opt);
        });
        if (currentLeague) leagueSelect.value = currentLeague;
        setText("league", leagueSelect.value);
      }

      inputs.forEach((input) => {
        sync(input);
        const handler = () => {
          sync(input);
          if (input.dataset.bind === "betAmount" || input.dataset.bind === "slipOdds") {
            updatePossibleWin();
          }
          if (["t1h1", "t1h2", "t2h1", "t2h2"].includes(input.dataset.bind)) {
            updateScores();
          }
        };
        input.addEventListener("input", handler);
        input.addEventListener("change", handler);
        input.addEventListener("blur", handler);
      });

      if (genIdBtn) {
        genIdBtn.addEventListener("click", () => {
          const prefixes = ["20", "21", "22", "19", "18"];
          const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
          let rest = "";
          for (let i = 0; i < 7; i += 1) {
            rest += Math.floor(Math.random() * 9) + 1;
          }
          const value = `${prefix}${rest}`;
          setText("slipId", value);
          if (customIdInput) customIdInput.value = value;
        });
      }

      if (customIdInput) {
        customIdInput.addEventListener("input", () => {
          const cleaned = customIdInput.value.replace(/\D/g, "").slice(0, 9);
          customIdInput.value = cleaned;
          if (cleaned.length) setText("slipId", cleaned);
        });
      }

      const setNowForSlip = () => {
        const now = new Date();
        const isoDate = now.toISOString().slice(0, 10);
        const hours = String(now.getHours()).padStart(2, "0");
        const mins = String(now.getMinutes()).padStart(2, "0");
        const time24 = `${hours}:${mins}`;

        const slipDateInput = document.querySelector('[data-bind="slipDateISO"]');
        const slipTimeInput = document.querySelector('[data-bind="slipTimeISO"]');
        if (slipDateInput) slipDateInput.value = isoDate;
        if (slipTimeInput) slipTimeInput.value = time24;
        if (slipDateInput) sync(slipDateInput);
        if (slipTimeInput) sync(slipTimeInput);
      };

      const betAmountInput = inputs.find((input) => input.dataset.bind === "betAmount");
      if (betAmountInput) sync(betAmountInput);
      updatePossibleWin();
      updateScores();
      setNowForSlip();

      const downloadCanvas = (canvas, filename, targetWidth, targetHeight) => {
        const output = document.createElement("canvas");
        output.width = targetWidth;
        output.height = targetHeight;
        const ctx = output.getContext("2d");
        ctx.drawImage(canvas, 0, 0, targetWidth, targetHeight);
        const link = document.createElement("a");
        link.download = filename;
        link.href = output.toDataURL("image/png");
        link.click();
      };

      const captureElement = async (el, filename, ratio) => {
        if (!window.html2canvas) return;
        const width = 601;
        const height = Math.round(width * ratio);
        const canvas = await window.html2canvas(el, {
          backgroundColor: "#f1f3f7",
          width: el.offsetWidth,
          height: el.offsetHeight,
          scale: 2,
        });
        downloadCanvas(canvas, filename, width, height);
      };

      if (downloadBtn) {
        downloadBtn.addEventListener("click", async () => {
          const opened = document.getElementById("openedExport");
          const won = document.getElementById("wonExport");
          if (opened) await captureElement(opened, "slip-opened.png", 749 / 601);
          if (won) await captureElement(won, "slip-won.png", 678 / 601);
        });
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  </body>
</html>

